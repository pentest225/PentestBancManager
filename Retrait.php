<?php 
session_start();

require 'admin/dataBase.php' ;
// INFORMATION DE L'ITILISATEUR
        // RECUPERATION DE SONS ID
        // if(isset($_GET['id'])){
        // $id=$_GET['id'];
        // }
        $db=DB::connect();
        $InfoUser=$db->prepare('SELECT * FROM client WHERE Nom= ?');
        $InfoUser->execute(array($_SESSION['Login']));
        $Info=$InfoUser->fetch();

// TRAITEMENT DES INFORMATION DE TRANSFERT

   $Code=$Montant=$CodeError=$MontantError=$IsSuccess=$typeTransaction="";
    if(!empty($_POST['form1']))
    {
        $Code=$_POST['Code'];
        $Montant=$_POST['Montant'];
        $frai=Frai($Montant);
        $IsSuccess=TRUE;
        $typeTransaction="Demande de Retrait";
        $CodeTransaction=CodeRetait();
        
        if($Code != $Info['code'])
        {
            $CodeError="Error :Code de Payement IVALIDE";
            $IsSuccess=FALSE;
        }
        if($Montant >($Info['Solde']+ $frai))
        {
            $MontantError="Votre Solde est INSUFFISANT pour Effectuer cette Transaction ";
            $IsSuccess=FALSE;
        }


        // SI TOUS VAS BIEN 
        if($IsSuccess)
        {
            $db=DB::connect();
            $UserNotification=$Info['Notification']+1;
            $statement=$db->prepare('INSERT INTO transactions( DateTransaction,TypeTransaction,Emmeteur,Montant,Frait_Transaction,CodeTransaction) VALUES (Now(),?,?,?,?,?)');
            $statement->execute(array($typeTransaction,$Info['Nom'],$Montant,$frai,$CodeTransaction));
           
        }
    }

// FONCTIN UTILS
    function CodeRetait()
    {
        $code =uniqid();
        return $code;
    }
    
    function Frai($Somme){
        $frai=0;
        if($Somme < 5000 )
        {
            $frai=150;
        }
        if($Somme>=5000 && $Somme < 10000)
        {
            $frai=450;
        }
        if($Somme>=10000 && $Somme< 25000)
        {
            $frai=650;
        }
        if($Somme>=25000 && $Somme< 50000)
        {
            $frai=1000;
        }
        if($Somme>=50000 && $Somme <100000)
        {
            $frai=2000;
        }
        if($Somme>=100000 && $Somme <200000)
        {
            $frai=3500;
        }
        if($Somme>=200000 && $Somme <200000)
        {
            $frai=4500;
        }
        if($Somme>=300000 && $Somme <500000)
        {
            $frai=10000;
        }
        return $frai;
    }
    

?>
<!-- ******************FIN DE LA ZONNE DE TRAITEMENT DES INFORMATION DEBUT DU FONT END*********************** -->
    <?php
        include 'nav.php';
    ?>
        <div class="container">
        <h2>PentestBanqueManager/Retrait </h2>
        <div class="col-md-4">
            <form action="Retrait.php" method="POST" class="form">
            
                <div class="form-group">
                    <label for="Montant">Somme  retirer </label>
                    <input id="Montant" class="form-control" name="Montant" type="number">
                    <div class="Error"><?php echo $MontantError?></div>
                </div>  
                <div class="form-group">
                    <label for="destination">Saisir Votre code de payement :</label>
                    <input type="password" name="Code" id="Code" class="form-control"<?php echo $Code?>>
                    <div class="Error"><?php echo $CodeError?></div>
                </div>
                <input type="submit" class="btn btn-success btn-lg" name="form1" value="Valide le Retrait">
                
            </form>
        </div>
        <div class="col-md-4">
            <?php 
                if($IsSuccess)
                {
                    echo ("
                    <div>
                        <div class='alert alert-success  alert-dismissible' role='alert'  >
                            <a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a>
                                <h4>Demande de  Retrais effectue  </h4> 
                                <p>Veille Passe au guiche muni du code de transaction suivent :<strong>".$CodeTransaction."</strong></p>
                                <Pour le retait en espece !!!!!!!>
                                <div class=''>
                                    <a href='profil.php 'class='btn btn-info'>Retour Profil </a>
                                    <a href='guichet.php'class='btn btn-success'>Passe Au Guiche </a>
                                </div>
                        </div>
                    </div>");
                }
                    
            ?>
        </div>
    </div>
</body>
</html>