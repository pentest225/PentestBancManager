<?php require 'admin/dataBase.php' ;
session_start();

// INFORMATION DE L'ITILISATEUR

        // if(isset($_GET['id'])){
        // $id=$_GET['id'];
        // }
        $db=DB::connect();
        $InfoUser=$db->prepare('SELECT * FROM client WHERE Nom= ?');
        $InfoUser->execute(array($_SESSION['Login']));
        $Info=$InfoUser->fetch();
// TRAITEMENT DES INFORMATION DE TRANSFERT

    $NumDest=$ConfNumDest=$Code=$Montant=$NumDestError=$ConfNumDestError=$CodeError=$MontantError=$type=$IsSuccess=$frai="";
    if(!empty($_POST['form1']))
    {
        $NumDest=$_POST['NumDest'];
        $ConfNumDest=$_POST['ConfNumDest'];
        $Code=$_POST['Code'];
        $Montant=$_POST['Montant'];
        $frai=Frai($Montant);
        $IsSuccess=TRUE;
        $Type='Depot';
        if(!VerifNum($NumDest))
        {
            $NumDestError="Desole vous ne pouver faire le depos sur ce Numerot Veillez verifier contacts ";
            $IsSuccess=FALSE;
        }
        if($ConfNumDest != $NumDest)
        {
            $ConfNumDestError ="Veillez verifier le Numerot du destinatair";
            $IsSuccess=FALSE;
        }
        if($Code != $Info['code'])
        {
            $CodeError="Error :Code de Payement IVALIDE";
            $IsSuccess=FALSE;
        }
        if($Montant >($Info['Solde']+ $frai))
        {
            $MontantError="Votre Solde est INSUFFISANT pour Effectuer cette Transaction ";
            $IsSuccess=FALSE;
        }



        // SI TOUS VAS BIEN 
        if($IsSuccess)
        {
            $db=DB::connect();
            // CREDITER LE SOLDE 
                // SELECTION DE L'ENCIENNE VALLEUR
            $Select=$db->prepare('SELECT Nom , Solde, Notification FROM client  WHERE Numero= ?');
            $Select->execute(array($NumDest));
            $InfoRes=$Select->fetch();
            $SoldeRes= $InfoRes['Solde'] ;
            $SoldeRes = $SoldeRes + $Montant;
            $Notif=$InfoRes['Notification'];
            $Notif=$Notif + 1;
            // MISE A JOURS DU SOLDE DU RECEVEUR
            $Updade=$db->prepare('UPDATE client SET Solde = ? , Notification= ? WHERE Numero = ? ');
            $Updade->execute(array($SoldeRes,$Notif,$NumDest));
            //DEBIT DE COMPTE DE L'EMETEUR 
                // SELECTION L'ENCIENNE VALLEUR
            
            $SoldeUser=$Info['Solde'];
            $SoldeUser =  $SoldeUser - ($Montant+$frai);
            $UserNotification=$Info['Notification']+1;
                // MISE A JOURS DU CREDIT DE L EMETEUR
            $Updade=$db->prepare('UPDATE client SET Solde = ? ,Notification =?  WHERE  Nom= ? ');
            $Updade->execute(array($SoldeUser,$UserNotification,$_SESSION['Login']));

            // MISE A JOUR  DES TABLES DE TRANSACTION 
            $UpdadeTransaction=$db->prepare('INSERT INTO transactions (DateTransaction,TypeTransaction,Emmeteur,Recepteur,Montant,Frait_Transaction) VALUES (now(),?,?,?,?,?)');
            $UpdadeTransaction->execute(array("Depot",$Info['Nom'],$InfoRes['Nom'],$Montant,$frai));

            // $Mise_A_Jour=$db->prepare('INSERT INTO transactions (DateTransaction ,TypeTransaction, Emmeteur,Recepteur,Montant) VALUES (now(),:TypeTransaction,:Emmeteur,:Recepteur,:Montant,:Frait_transaction)');
            // $Mise_A_Jour->execute(array(
            //     "TypeTransaction"=>"Depot",
            //     ":Emmeteur"=>$Info['Nom'],
            //     ":Recepteur"=>$NumDest,
            //     ":Montant"=>$Montant,
            //     ":Frait_transaction"=>$frai)
            // );  
            DB::Desconexte();
        }
    }

// FONCTIN UTILS
    function VerifLog($UserLog)
    {
        //connexion a la base de donnee ;
        $db=DB::connect();
        $verif =$db->prepare('SELECT * FROM client WHERE Nom = ?');
        $verif->execute(array($UserLog));
        $reponce = $verif->fetch(); 
        if($reponce){
            return true;
        }
        else{
            return false;
        }
        DB::Desconexte();
    }
    function VerifNum($UserNum)
    {
        //connexion a la base de donnee ;
        $db=DB::connect();
        $verif =$db->prepare('SELECT * FROM client WHERE Numero = ?');
        $verif->execute(array($UserNum));
        $reponce = $verif->fetch(); 
        if($reponce){
            return true;
        }
        else{
            return false;
        }
        DB::Desconexte();
    }

    function Frai($Somme){
        $frai=0;
        if($Somme < 5000 )
        {
            $frai=150;
        }
        if($Somme>=5000 && $Somme < 10000)
        {
            $frai=450;
        }
        if($Somme>=10000 && $Somme< 25000)
        {
            $frai=650;
        }
        if($Somme>=25000 && $Somme< 50000)
        {
            $frai=1000;
        }
        if($Somme>=50000 && $Somme <100000)
        {
            $frai=2000;
        }
        if($Somme>=100000 && $Somme <200000)
        {
            $frai=3500;
        }
        if($Somme>=200000 && $Somme <200000)
        {
            $frai=4500;
        }
        if($Somme>=300000 && $Somme <500000)
        {
            $frai=10000;
        }
        return $frai;
    }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>PentestBanqueManager/Transaction</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

</head>
<body>
    <?php
        include 'nav.php';
    ?>
        <div class="container depot">
        <h2>PentestBanqueManager/Transaction</h2>
       
        <div class="row">
            <div class="col-md-6">
            <form action="Transaction.php" method="POST" class="form">
            <div class="form-group">
                <label for="destination">Numerot Destinataire :</label>
                <input type="number" name="NumDest" id="NumDest" class="form-control" value="<?php echo $NumDest?>">
                <div class="Error" ><?php echo $NumDestError?></div>
            </div>
            <div class="form-group">
                <label for="destination">Confirmer Le Numerot :</label>
                <input type="number" name="ConfNumDest" id="ConfNumDest" class="form-control" value="<?php echo $ConfNumDest?>">
                <div class="Error" ><?php echo $ConfNumDestError?></div>
            </div>
            <div class="form-group">
                <label for="destination">Saisir Votre code de payement :</label>
                <input type="password" name="Code" id="Code" class="form-control"<?php echo $Code?>>
                <div class="Error"><?php echo $CodeError?></div>
            </div>
            
            <div class="form-group">
                <label for="Montant">Montant de Transaction</label>
                <input id="Montant" class="form-control" name="Montant" type="number">
                <div class="Error"><?php echo $MontantError?></div>
            </div>
            <input type="submit" class="btn btn-success btn-lg" name="form1" value="Valide la transaction">
            
        </form>
            
            
            </div>
            <div class="col-md-6">
            <?php 
            if($IsSuccess)
            {
                $db=DB::connect();
                $request=$db->query('SELECT * FROM transactions');
                $Transaction=$request->fetch();
                echo ("
                <div class=' row'>
                <div class='alert alert-success  alert-dismissible col-md-6' role='alert'  >
                <a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a>
                    <h4> Transaction EFFECTUE AVEC SUCCES </h4> 
                    <h5>".$Transaction['TypeTransaction']." de ".$Montant." </h5>
                    <h5>Effectue par ".$Info['Nom']." :".$Info['Numero']."
                     <h5>A ".$NumDest." :   </h5>
                    <h5> Frait de la transaction  :".$frai."   </h5>
                    <div class=''><a href='profil.php 'class='btn btn-info'>Retour Profil </a>
                </div>
                </div>");
            }
                
        ?>
            
            </div>
        
        </div>
        
    </div>
</body>
</html>