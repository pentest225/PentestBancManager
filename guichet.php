<?php 
    require 'admin/dataBase.php' ;
    $CodeError=$CodeRetrait="";
    if(isset($_POST['form1']))
    {
        $CodeRetrait=$_POST['CodeRetrait'];
        $Valide=FALSE;
        $typeTransaction="Validation Retrait";

        // connexion a la table des transaction 
        $db=DB::connect();
        $query=$db->prepare('SELECT * FROM transactions WHERE CodeTransaction = ?');
        $query->execute(array($CodeRetrait));
        $reponse=$query->fetch();
        if($reponse)
        {
            // SI L'UTILISATEUR SAISI LE SAISI LA  BONNE INFORMATION
                // 1=>SE CONNECTER A LA BD RECUPERE LES INFO CORRESPONDANS A LA DEMANDE 
                    $Valide=TRUE;
                    $db=DB::connect();
                    // AJOUTE UNE NOTIFICATION 
                    $InfoUser=$db->prepare('SELECT * FROM client WHERE Nom= ?');
                    $InfoUser->execute(array($reponse['Emmeteur']));
                    $Info=$InfoUser->fetch();
                    $Info['Notification'] += 1;
                    // CREDITE LE COMPTE 
                    $Info['Solde'] -=$reponse['Montant']+$reponse['Frait_transaction'];
                    $UpdateSolde= $db->prepare('UPDATE client set Solde =? ,Notification = ? WHERE Nom = ?');
                    $UpdateSolde->execute(array($Info['Solde'],$Info['Notification'],$Info['Nom']));
                    // ENREGISTRE LA TRANSACTION 
                    $Mise_A_Jour=$db->prepare('INSERT INTO transactions (DateTransaction ,TypeTransaction, Emmeteur,Montant,Frait_transaction,CodeTransaction) VALUES (now(),:type_transaction,:Emmeteur,:Montant,:Frait_transaction,:CodeTransaction)');
                    $Mise_A_Jour->execute(array(
                        ":type_transaction" => $typeTransaction,
                        ":Emmeteur"=>$Info['Nom'],
                        ":Montant"=>$reponse['Montant'],
                        ":Frait_transaction"=>$reponse['Frait_transaction'],
                        ":CodeTransaction"=>$reponse['CodeTransaction'])
                    );
                    DB::Desconexte();
                // }
                // else
                // {
                //     $CodeError="Desolet ce Numero de carte n'est plus valide ";
   
                // }
                // echo("le deuxime formulaire est bon ");
              
        }
        else{
            $CodeError="Desolet ce Numero de carte ne correspond a aucune DEMANDE DE RETRAI";
        }
        if(!empty($_POST['ValideRetrait'])  )
        {
            echo("le deuxime formulaire est bon ");
            $db=DB::connect();
                // AJOUTE UNE NOTIFICATION 
            $InfoUser=$db->prepare('SELECT * FROM client WHERE id= ?');
            $InfoUser->execute(array($id));
            $Info=$InfoUser->fetch();
            $Info['Notification'] += 1;
            // CREDITE LE COMPTE 
            $Info['Solde'] -=$reponse['Montant']+$reponse['Frait_transaction'];
            $UpdateSolde= $db->prepare('UPDATE client set Solde =? ,Notification = ?');
            $UpdateSolde->execute(array($Info['Solde'],$Info['Notification']));
            // ENREGISTRE LA TRANSACTION 
            $Mise_A_Jour=$db->prepare('INSERT INTO transactions (DateTransaction ,TypeTransaction, Emmeteur,Montant,Frait_transaction,CodeTransaction) VALUES (now(),:type_transaction,:Emmeteur,:Montant,:Frait_transaction,:CodeTransaction)');
            $Mise_A_Jour->execute(array(
                ":type_transaction" => $typeTransaction,
                ":Emmeteur"=>$Info['Nom'],
                ":Montant"=>$Montant,
                ":Frait_transaction"=>$reponse['Frait_transaction'],
                ":CodeTransaction"=>$CodeTransaction)
            );
            DB::Desconexte();

        }
    }

?>

<?php include 'navIndex.php' ?>
<div class="container">
    <div class="col-md-4">

    </div>
    <div class="col-md-4 guiche">
        <h3>Bienvenue au guichet automatique</h3>
        <form action="guichet.php" method="POST" class="form">
           
            
            <div class="form-group">
                <label for="destination">Veillez inserer votre cate Bancaire :</label>
                <input type="password" name="CodeRetrait" id="Code" class="form-control" value=<?php echo $CodeRetrait?>>
                <div class="Error"><?php echo $CodeError?></div>
            </div>
            <input type="submit" class="btn btn-info btn-lg compte1" name="form1" value="Valide le Retrait">
            
        </form>
    </div>
    <div class="col-md-4">
        <?php 
            // $typeInput="hidden";
            if(isset($Valide) && $Valide)
            {
                $ValideRetrait="ValideRetrait";
                $typeInput="submit";
                echo("
                <div class='alert alert-success  alert-dismissible' role='alert'  >
                    <h4> Info Retrais  </h4> 
                        <div class='container'>
                            <p>Retrait d'une Somme de :<strong>".$reponse['Montant']."</strong></p>
                            <p>Demande par :<strong>".$reponse['Emmeteur']."</strong></p>
                            <p>Frait Du retrait :<strong>".$reponse['Frait_transaction']."</strong></p>
                            <p>Le :<strong>".$reponse['DateTransaction']."</strong></p>
                        </div>
                    <div class=''> 
                        
                    <form action='guichet.php' method='POST'>
                    <input type='".$typeInput."' class='btn btn-success btn-lg' name='ValideRetrait' value='Valide '>
                   
                        <a href='guichet.php'class='btn btn-success'>Anuller </a>

                    </form>
                    </div>
                </div>

                ");
                };
            
        ?>

                    
</div>
    