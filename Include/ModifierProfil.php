<?php
    session_start();

    require_once ('../admin/dataBase.php');
    $db=DB::connect();
        $InfoUser=$db->prepare('SELECT * FROM client WHERE Nom= ?');
        $InfoUser->execute(array($_SESSION['Login']));
        $Info=$InfoUser->fetch();

    $Login= $Psw =  $Psw_conf = $Num= $Image = $LoginError = $Psw_confError = $NumError= $IsSuccess = $ImagePath = $ImageExtension =$ImageError= $PswError="";
    
    // TRAITEMENT DU FORMULAIRE D'INSCRIPTION
    if(isset($_POST['form']))
    {
        
        $Login =VerifInfo($_POST['Login']);
        $Psw  = VerifInfo($_POST['Psw']);
        $Psw_conf =VerifInfo($_POST['Psw_conf']);
        $Image = $_FILES['image']['name'];
        $ImagePath="../images/".basename($Image);
        $ImageExtanssion =pathinfo($ImagePath,PATHINFO_EXTENSION);
        $IsSuccess=TRUE;
        $Num=$_POST['Num'];
        $IsUploaded=TRUE;
  
        if((!empty($Login) && VerifLog($Login))){
            $LoginError="Erreur : CE LOGIN EXISTE DEJAT";
            $IsSuccess=FALSE;
        }
        else{
            $Info['Nom']=$Login;
        };

        if((VerifNum($Num) && !empty($Num))){
            $NumError="Desole ce Numerot est dejat prix <br/>Veiller Prendre un autre";
            $IsSuccess=FALSE;
        }
        else{
            $Info['Numero']=$Num;
        };

        if(!empty($Psw) && $Psw != $Info['code'])
        {
           $PswError="Erreur :Veillez verifier votre code de payement !!!!";
            $IsSuccess=FALSE;
        }
        elseif(!empty($Psw_conf) && strlen($Psw_conf) < 4)
        {
            $Psw_confError="Veillez saisir votre Nouveaux code de Payement Au moin 4 charateres !!!!";
            $IsSuccess=FALSE;
        }
        else
        {
            $Info['code']=$Psw_conf;
        }
        if( !empty ($Image))
        {

            if($ImageExtanssion !="jpeg" && $ImageExtanssion !="png" && $ImageExtanssion != "gif" && $ImageExtanssion != "jpg"){
                $ImageError="Seul les fichier jpeg ,png ,gif jpg sons autorise";
                $IsUploaded=false;
            }
            if(file_exists($ImagePath)){
                $ImageError='ce fichier existe dejat';
                $IsUploaded=false;
            }
            if($_FILES['image']['size']>50000){
                $ImageError="fichier trop lourd";
                $IsUploaded=false;
            }
            
            if(!move_uploaded_file($_FILES['image']['tmp_name'],$ImagePath)){
                $ImageError="Probleme de chargement du fichier";
                $IsUploaded=false;
            }
        }
        if($IsUploaded)
            {
                $Info['UserImage']=$Image;
            }
           
        // FIN DE LA VERIFICATION DE L'IMAGES 
        if($IsSuccess )
        {

            $DefaultSolde=200000;
            $Code=CodePayement($Login,$Num);
            $db=DB::connect();
            $UpdateUser =$db->prepare('UPDATE client SET Nom = ?,Numero= ?,code = ?,Passeword= ?,UserImage = ?');
            $UpdateUser->execute(array($Info['Nom'],$Info['Numero'],$Info['code'],$Info['Passeword'],$Info['UserImage']));
        }
        
    }
    function VerifInfo($info)
    {
        $info=trim($info);
        $info=htmlspecialchars($info);
        $info=stripslashes($info);
        return $info;
    }
     
    function VerifNum($UserNum)
    {
        //connexion a la base de donnee ;
        $db=DB::connect();
        $verif =$db->prepare('SELECT * FROM client WHERE Numero = ?');
        $verif->execute(array($UserNum));
        $reponce = $verif->fetch(); 
        if($reponce){
            return true;
        }
        else{
            return false;
        }
        DB::Desconexte();
    }
    function VerifLog($UserLog)
    {
        //connexion a la base de donnee ;
        $db=DB::connect();
        $verif =$db->prepare('SELECT * FROM client WHERE Nom = ?');
        $verif->execute(array($UserLog));
        $reponce = $verif->fetch(); 
        if($reponce){
            return true;
        }
        else{
            return false;
        }
        DB::Desconexte();
    }
    function CodePayement($Log ,$Num ){
        $text=substr($Log,-(strlen($Log)/2),2);
        $NumbreAleatoir =round(1,100);
        $code='';
        $code .=$NumbreAleatoir;
        $code .= $text;
        $code .=substr($Num,-strlen($Log),2);
        return $code;
    }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../css/style.css">


    
</head>
<body>
    <!-- BARE DE MENU -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
            <a class="navbar-brand" href="#">PentestBenqueM</a>
            </div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="../profil.php">Profil</a></li>
                <li><a href="../Transaction.php">Depot</a></li>
                <li><a href="../Retrait.php">Retrait</a></li>
                </li>
                <li><a href="../historique.php"> Historique</a></li>
                <li><a href="../contact.php"> Contacts</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            <li>
                <a href="#">                 
                    <img src="<?php echo'images/'.$Info['UserImage'].''?>" alt="" class="ImgProfil" height=35px>
                        <?php 
                                if(isset($Info['Nom'])){
                                    echo ($Info['Nom']);
                                }
                            ?>
                </a>
                </li>
            <li><a href="../deconnexion.php"><span class="glyphicon glyphicon-log-in"></span>
                </a>
            </li>
            </ul>
        </div>
    </nav>
        <!-- FIN DE LA BARRE DE MENU -->
    <div class="container ">
        <h1>MISE A JOUR DE VOTRE COMPTE</h1>
       
        <!-- FORMULAIRE --> 
        <div class="col-md-4 ">
            <form id="contact-form" action="ModifierProfil.php" method="POST" role="form" class="form " enctype="multipart/form-data">
                <div class="container ">
                    <div class="form-group">
                        <label>Nouvau Login <span class="blue">*</span> </label>
                        <input type="text"   class="form-control " id="Prenom" name="Login" value="<?php echo $Login?>">
                        <div class="LoginError" ><?php echo $LoginError?> </div>
                    </div>
                    <div class="form-group">
                        <label>Chamge de Numero<span class="blue"> *</span></label>
                        <input type="tel"  class="form-control " id="Num" name="Num" value="<?php echo $Num ?>">
                        <div class="LoginError" ><?php echo $NumError?></div>
                    </div>
                    <div class="form-group">
                        <label>Ensien Code Payement<span class="blue"> *</span></label>
                        <input type="password" class="form-control " id="Psw" name="Psw" <?php echo $PswError ?>>
                        <div class="LoginError" value=""></div>
                    </div>
                    <div class="form-group">
                        <label> Nouveaux Code Payement<span class="blue"> *</span></label>
                        <input type="password" class="form-control " id="Psw_conf" name="Psw_conf">
                        <div class="LoginError"><?php echo $Psw_confError?></div>
                        
                    </div>
                    <div class="form-group">
                        <label for="Image">Charger Une Image</label>
                        <input type="file" name="image"><div class="LoginError"><?php echo $ImageError ?></div>
                    </div>
                    <div class="form-group">
                        <input  type="submit" class="btn btn-success btn-lg" value="S'inscrire" name='form'>
                    </div>
                </div>
            </form>
        </div>
        <!-- MESSAGE DE FELISITATION A AFFICHE SI TOUS EST BON  -->
        <div class="col-md-4">
            <?php 
                if($IsSuccess)
                {
                    echo ("
                    <div class='container col-md-5row'>
                    <div class='alert alert-success  Felicitation col-md-6' role='alert'  >
                        <h4> felicitation <strong> ". $Login."</strong> Les Modifications effctue</h4> 
                        <h5><strong>Votre Login est :<em>".$Login."</em></strong></h5>
                        <div class=''><a href='../profil.php 'class='btn btn-info'> Profil </a>
                        <a href='../index.php' class='btn btn-success'> Home </a></div>
                    </div>
                    </div>");
                }
                    
            
            
            ?>
        </div>
    </div>
</body>
</html>