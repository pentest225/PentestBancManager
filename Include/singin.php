<?php
    session_start();

    require_once ('../admin/dataBase.php');


    $Login= $Psw =  $Psw_conf = $Num= $Image = $LoginError = $Psw_confError = $NumError= $IsSuccess = $ImagePath = $ImageExtension =$ImageError= $PswError="";
    
    // TRAITEMENT DU FORMULAIRE D'INSCRIPTION
    if(isset($_POST['form']))
    {
        
        $Login =VerifInfo($_POST['Login']);
        $Psw  = VerifInfo($_POST['Psw']);
        $Psw_conf =VerifInfo($_POST['Psw_conf']);
        $Image = $_FILES['image']['name'];
        $ImagePath="../images/".basename($Image);
        $ImageExtanssion =pathinfo($ImagePath,PATHINFO_EXTENSION);
        $IsSuccess=TRUE;
        $Num=$_POST['Num'];

        if(empty($Login))
        {
            $LoginError="Veillez saisir votre Nom";
            $IsSuccess=FALSE;
        }elseif(VerifLog($Login)){
            $LoginError="Desole ce login existe dejat dans la base de donne";
        }
        if(VerifNum($Num)){
            $NumError="Desole ce Numerot est dejat prix <br/>Veiller Prendre un autre";
            $IsSuccess=FALSE;
        }
        if(empty($Psw))
        {
            $Tableau['PswError']="Vous Avez oublier de saisir le Mod de Passe";
            $IsSuccess=FALSE;
        }
        if($Psw != $Psw_conf )  
        {
           $Psw_confError="Les Deux Mots de passe ne concordes Pas";
            $IsSuccess=FALSE ;
        }
        else{
            // PROTOTY DE HACHAGE DES MOTS DE PASSES
            $Psw=sha1($Psw);
        };
       
        if(empty ($Image))
            {
                $Image='defaultUser.jpg';
            }
            else{
                $NweUpdate=TRUE;
                if($ImageExtanssion !="jpeg" && $ImageExtanssion !="png" && $ImageExtanssion != "gif" && $ImageExtanssion != "jpg"){
                    $ImageError="Seul les fichier jpeg ,png ,gif jpg sons autorise";
                    $IsSuccess=FALSE;
                }
                if(file_exists($ImagePath)){
                    $ImageError='ce fichier existe dejat';
                    $IsUploaded=false;
                }
                
                if($_FILES['image']['size']>50000){
                    $ImageError="fichier trop lourd";
                    $IsUploaded=false;
                }
                if(!move_uploaded_file($_FILES['image']['tmp_name'],$ImagePath)){
                    $ImageError="Probleme de chargement du fichier";
                    $IsUploaded=false;
                }
            }

        // FIN DE LA VERIFICATION DE L'IMAGES 
        if($IsSuccess)
        {

            $DefaultSolde=200000;
            $Code=CodePayement($Login,$Num);
            $db=DB::connect();
            $Date=date('D-M-Y');
            $Insert=$db->prepare("INSERT INTO client (Nom ,Password ,Numero,solde,code,UserImage,DateInscription) VALUES (?,?,?,?,?,?,now()) ");
            $Insert->execute(array($Login,$Psw,$Num,$DefaultSolde,$Code,$Image));
            // $Rid=$db->prepare('SELECT  FROM client WHERE Nom =?');
            // $Rid->execute(array($Login));
            // $ID=$Rid->fetch();
            // $id=$ID['id'];
            $_SESSION['Login']=$Login;
            var_dump($_SESSION);
        }
        
    }
    function VerifInfo($info)
    {
        $info=trim($info);
        $info=htmlspecialchars($info);
        $info=stripslashes($info);
        return $info;
    }
    // TRAITEMENT DU FORMULAIRE DE CONNEXION
    $Log=$Pass="";
    // TRAITEMENT DU FORMULAIRE DE CONNEXION
    if(isset($_POST['form1']))
    {
        $Log=$_POST['Login'];
        $Pass =$_POST['passeword'];
        $Pass=sha1($Pass);
        VerifUser($Log,$Pass);
    }


    function VerifUser($UserLogin,$UserPasseword)
    {
        //connexion a la base de donnee ;
        $db=DB::connect();
        $verif =$db->prepare('SELECT * FROM client WHERE Nom = ?');
        $verif->execute(array($UserLogin));
        $reponce = $verif->fetch();
        // On verifie si le login existe 
        if($reponce){
            // Si Oui verifie le mot de passe
            
            if($reponce['Password']== $UserPasseword)
            {
                header('Location: ../profil.php');
            }
            else{
                header('Location:connexion.php');
            }
        }
        else{
            header('Location:connexion.php');
        }
        DB::Desconexte();
    }
    function VerifNum($UserNum)
    {
        //connexion a la base de donnee ;
        $db=DB::connect();
        $verif =$db->prepare('SELECT * FROM client WHERE Numero = ?');
        $verif->execute(array($UserNum));
        $reponce = $verif->fetch(); 
        if($reponce){
            return true;
        }
        else{
            return false;
        }
        DB::Desconexte();
    }
    function VerifLog($UserLog)
    {
        //connexion a la base de donnee ;
        $db=DB::connect();
        $verif =$db->prepare('SELECT * FROM client WHERE Nom = ?');
        $verif->execute(array($UserLog));
        $reponce = $verif->fetch(); 
        if($reponce){
            return true;
        }
        else{
            return false;
        }
        DB::Desconexte();
    }
    function CodePayement($Log ,$Num ){
        $text=substr($Log,-(strlen($Log)/2),2);
        $NumbreAleatoir =round(1,100);
        $code='';
        $code .=$NumbreAleatoir;
        $code .= $text;
        $code .=substr($Num,-strlen($Log),2);
        return $code;
    }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../css/style.css">


    
</head>
<body>
    <!-- BARE DE MENU -->
    <header>
        <nav class="navbar navbar-inverse">
            <div class="container">
              <div class="navbar-header">
                <a class="navbar-brand" href="index.php">PentestBanckManager</a>
              </div>
              <ul class="nav navbar-nav navbar-right">
                <li class="active"><a href="connexion.php">Connexion</a></li>
              </ul>
            </div>
          </nav>
    </header>
    <!-- FIN DE LA BARRE DE MENU -->
        <div class="container  ">
            <h4>Creation de compte</h4>
        <!-- FORMULAIRE --> 
            <div class="col-md-4 ">
                <form id="contact-form" action="singin.php" method="POST" role="form" class="form " enctype="multipart/form-data">
                    <div class="container ">
                        <div class="form-group">
                            <label>Prenom et Nom  <span class="blue">*</span> </label>
                            <input type="text"   class="form-control " id="Prenom" name="Login" value="<?php echo $Login?>">
                            <div class="LoginError" ><?php echo $LoginError?> </div>
                        </div>
                        <div class="form-group">
                            <label>Numero<span class="blue"> *</span></label>
                            <input type="tel"  class="form-control " id="Num" name="Num" value="<?php echo $Num ?>">
                            <div class="LoginError" ><?php echo $NumError?></div>
                        </div>
                        <div class="form-group">
                            <label>Mot de passe<span class="blue"> *</span></label>
                            <input type="password" class="form-control " id="Psw" name="Psw" <?php echo $PswError ?>>
                            <div class="LoginError" value=""></div>
                        </div>
                        <div class="form-group">
                            <label> Confirmer Votre Mot de passe<span class="blue"> *</span></label>
                            <input type="password" class="form-control " id="Psw_conf" name="Psw_conf">
                            <div class="LoginError"><?php echo $Psw_confError?></div>
                            
                        </div>
                        <div class="form-group">
                            <label for="Image">Charger Une Image</label>
                            <input type="file" name="image"><div class="LoginError"><?php echo $ImageError ?></div>
                        </div>
                        <div class="form-group">
                            <input  type="submit" class="btn btn-success btn-lg" value="S'inscrire" name='form'>
                        </div>
                    </div>
                </form>
            </div>
            <!-- MESSAGE DE FELISITATION A AFFICHE SI TOUS EST BON  -->
            <div class='container col-md-4 row'>

                <?php 
                    if($IsSuccess)
                    {
                        echo ("
                        <div class='alert alert-success  Felicitation ' role='alert'  >
                            <h4> felicitation <strong> ". $Login."</strong> Votre compte <strong>PentestBanques</strong> a ete cree avec succes  ;)</h4> 
                            <h5><strong>Votre Login est :<em>".$Login."</em></strong></h5>
                            <div class=''><a href='../profil.php 'class='btn btn-info'> Profil </a>
                            <a href='../index.php' class='btn btn-success'> Home </a></div>
                        </div>
                        ");
                    }
                        
                
                
                ?>
            </div>
        </div>
</body>
</html>